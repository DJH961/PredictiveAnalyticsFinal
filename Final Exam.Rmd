---
title: "Predictive Analytics - Final Exam"
date: "13/06/2025"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  out.width = "60%",
  message = FALSE
)

library(tidyverse)
library(urca)
library(fpp3)
library(zoo)
library(strucchange)
```

## Data Loading and Exploration

```{r loading}
df1 <- read_csv("wikipedia_2007-2015_monthly.csv", show_col_types = FALSE) 
df2 <- read_csv("wikipedia_2016-2025_monthly.csv", show_col_types = FALSE)

#Excluding data after 2015, as this is covered by df2
df1 <- df1 %>%
  filter(as_date(month) < as_date("2016-01-01"))

# Excluding data after May 2025, as this is the newest data available at this time - this is for comparability if a newer dataset gets downloaded
df2 <- df2 %>%
  filter(as_date(month) < as_date("2025-06-01"))

views_raw <- bind_rows(df1, df2) %>%
  transmute(
    month = as_date(month),
    views = total.total    
  ) %>%
  arrange(month)
```

```{r exploration}
glimpse(views_raw)
summary(views_raw)
views_raw %>% ggplot(aes(x = month, y = views)) + geom_line()
```

```{r check_duplicates}
views_raw %>%
  count(month) %>%
  filter(n > 1)
```

```{r tsibble}
views_tsibble <- views_raw %>% 
  mutate(month = yearmonth(month)) %>%
  as_tsibble(index = month)

has_gaps(views_tsibble)
interval(views_tsibble)
```
```{r}


# Step 2: Compute spectral entropy

spectral_results <- views_tsibble %>%
  features(.vars = views_tsibble$views, features = feat_spectral)

# Step 3: View entropy value
print(spectral_results)
```




## Time Series Analysis

```{r}
# Seasonal plot
views_tsibble %>% gg_season(views) + ggtitle("Seasonality")

# Subseries plots (show month-to-month or weekday patterns)
views_tsibble %>% gg_subseries(views) + ggtitle("Subseries")

# Yearly variation (standard deviation proxy)
views_tsibble %>%
  mutate(year = year(month)) %>%
  index_by(year) %>%
  summarise(sd_views = sd(views)) %>%
  autoplot(sd_views) + ggtitle("Yearly Std Dev")

```

## STL Decomposition

```{r STL Decomposition}
views_tsibble %>%
  model(STL(log(views) ~ season(window = "periodic"))) %>%
  components() %>%
  autoplot() + ggtitle("STL Decomposition (log transformed)")
```

```{r ACF PACF}

views_tsibble %>% ACF(views) %>% autoplot() + ggtitle("ACF")

views_tsibble %>% PACF(views) %>% autoplot() + ggtitle("PACF")
```

## Structural Breaks Analysis

```{r}
# Add lagged values and retain index
views_tsi <- views_tsibble %>%
  mutate(
    Lag0 = views,
    Lag1 = lag(views)
  )

# Check shift-level features (e.g., max change point)
views_tsi %>%
  features(Lag0, features = shift_level_max)

# Convert to time series for strucchange
views_ts <- as.ts(views_tsi)

# Rolling F-statistics (exclude 15% from start and end)
qlr <- Fstats(Lag0 ~ Lag1, data = views_ts, from = 0.15)

# Plot F-statistics
pdf("FStats.pdf")
plot(qlr, main = "Rolling F-Statistics for Structural Breaks")
dev.off()

# SupF test (Andrews' test for structural change)
test <- sctest(qlr, type = "supF")
print(test)

# Estimate breakpoints (with significance level)
breaks <- breakpoints(qlr, alpha = 0.05)
print(breaks)

# Plot again with breakpoints
plot(qlr, alpha = 0.1, main = "F Statistics with Breakpoints")
lines(breaks)
```




```{r}
#locate the number of January 2016 to analyze as a possible break point
poss_break_point <- which(views_tsibble$month == yearmonth("2016-01"))
chow_result <- sctest(formula = Lag0 ~ Lag1, type = "Chow", point = poss_break_point, data = views_ts)
print(chow_result)
```


```{r}
views_second_half <- views_ts[(poss_break_point + 1):nrow(views_ts), ]
views_ts_second_half <- as.ts(views_second_half)

qlr2 <- Fstats(Lag0 ~ Lag1, data = views_ts_second_half, from = 0.15)

# SupF test (Andrews' test for structural change)
test <- sctest(qlr2, type = "supF")
print(test)

# Estimate breakpoints (with significance level)
breaks <- breakpoints(qlr2, alpha = 0.05)
print(breaks)

# Plot again with breakpoints
plot(qlr, alpha = 0.1, main = "F Statistics with Breakpoints")
lines(breaks)

```

